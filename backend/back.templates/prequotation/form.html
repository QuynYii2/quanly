{literal}
<script language="javascript" type="text/javascript">
jQuery(document).ready(function($) {
	$("#form-admin").validate();

    $('.date-time').datetimepicker({
        showSecond: true, changeMonth: true, changeYear: true,
        dateFormat: "dd-mm-yy", timeFormat: 'HH:mm:ss'
    });

	$('a.toolbar[task="cancel"]').click(function(){
		$('input').removeClass('required');
		$('input#task').val('cancel');
		$('form.form-admin').submit();
	});

	$('a.remimage').click(function(){
		$(this).remove();
		$('img#itemimage').remove();
		$('input#remimage').val($(this).attr('image'));
	});
	$('a.remsocial').click(function(){
		$(this).remove();
		$('img#itemsocial').remove();
		$('input#remsocial').val($(this).attr('social'));
	});
	$('.meta-limiters').each(function(){
		var title = $(this).attr('fortit');
		$(this).limit('160', $('span#'+title));
	});

    $('button#export').click(function(){
        $('input#task').val('export');
        $('form.form-admin').submit();
    });

    $('button#sendto').click(function(){
        $('input#task').val('sendto');
        $('form.form-admin').submit();
    });
});
</script>
{/literal}

<form action="" method="post" name="frmPreQuotation" id="form-admin" class="form-validate form-admin" enctype="multipart/form-data">
	<input type="hidden" id="task" name="task" value=""/>
	<input type="hidden" id="option" name="option" value="prequotation"/>
	<input type="hidden" id="view" name="view" value="form" />
	<input type="hidden" name="hiddenimage" value="{$ObjectData.image}" />
	<input type="hidden" name="hiddensocial" value="{$ObjectData.social}" />
    <div class="row">
        <div class="col-sm-6">
            <fieldset class="adminform">
                <legend><label>{#INFO_ONE_LANGUAGE#}</label></legend>
                <div id="forlanguage">
                    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                        {foreach key=key item=items from=$languages}
                        <div class="panel panel-default">
                            <div class="panel-heading" role="tab" id="heading{$items.id}">
                                <h4 class="panel-title">
                                    <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse{$items.id}" aria-expanded="true" aria-controls="collapse{$items.id}">
                                        {$items.name}
                                    </a>
                                </h4>
                            </div>
                            <div id="collapse{$items.id}" class="panel-collapse collapse {if $key eq 0}in{/if}" role="tabpanel" aria-labelledby="heading{$items.id}">
                                <div class="panel-body">
                                    <input type="hidden" id="oldid_{$items.code}" name="vform[oldid][{$items.code}]" value="{$ObjectLang[$items.code].id}"/>
                                    <div class="form-group">
                                        <label for="name_{$items.code}">{#TITLE#}:</label>
                                        <input type="text" class="form-control {if $key eq 0}required{/if}" id="name_{$items.code}" name="vform[name][{$items.code}]" value="{$ObjectLang[$items.code].name}"/>
                                    </div>

                                    <div class="form-group">
                                        <label for="introtext_{$items.code}">{#INTROTEXT#}: </label>
                                        <textarea id="introtext_{$items.code}" name="vform[introtext][{$items.code}]" class="form-control">{$ObjectLang[$items.code].introtext}</textarea>
                                    </div>
                                    <!--
                                    <div class="form-group">
                                        <label for="tags_{$items.code}">{#TITLE_TAGS#}:</label>
                                        <input type="text" class="form-control" id="tags_{$items.code}" name="vform[tags][{$items.code}]" value="{$ObjectLang[$items.code].tags}"/>
                                    </div>
                                    <div class="form-group">
                                        <label for="meta_{$items.code}">{#TITLE_META#}:</label>
                                        <textarea fortit="tit_meta_{$items.code}" class="form-control meta-limiters" id="meta_{$items.code}" name="vform[meta][{$items.code}]">{$ObjectLang[$items.code].meta}</textarea>
                                        <div class="char-limit">The meta description will be limited to 160 chars, <span id="tit_meta_{$items.code}">0</span> chars left.</div>
                                    </div>
                                    -->
                                </div>
                            </div>
                        </div>
                        {/foreach}
                    </div>
                </div>
            </fieldset>
        </div>
        <div class="col-sm-6">
            <fieldset class="adminform">
                <legend><label>{#INFO_ALL_LANGUAGE#}</label></legend>
                <div class="row">
                    <div class="col-sm-3">
                        <div class="form-group">
                            <label for="code">{#CODE#}:</label>
                            <input type="text" class="form-control required" id="code" name="vform[code]" value="{$ObjectData.code}"/>
                        </div>
                    </div>
                    <div class="col-sm-3">
                        <div class="form-group">
                            <label for="conversion">{#CONVERSION#}:</label>
                            <input type="text" class="form-control required number" id="conversion" name="vform[conversion]" value="{$ObjectData.conversion}"/>
                        </div>
                    </div>
                    <div class="col-sm-3">
                        <div class="form-group">
                            <label for="numday">{#NUMDAY#}:</label>
                            <input type="text" class="form-control required number" id="numday" name="vform[numday]" value="{$ObjectData.numday}"/>
                        </div>
                    </div>
                    <div class="col-sm-3">
                        <div class="form-group">
                            <label for="numday" style="display: block;">&nbsp;</label>
                            <button type="button" id="add-quotation" class="btn btn-primary">{#ADD_PRICELIST#}</button>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-4">
                        <div class="form-group">
                            <label for="departure">{#DEPARTURE#}:</label>
                            <input type="text" class="form-control required datetime date-time" id="departure" name="vform[departure]" value="{$ObjectData.departure|date_format:'%d-%m-%Y %H:%M:%S'}"/>
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <div class="form-group">
                            <label for="markup">{#MARKUP#}:</label>
                            <input type="text" class="form-control required number" id="markup" name="vform[markup]" value="{$ObjectData.markup}"/>
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <div class="form-group">
                            <label for="discount">{#DISCOUNT#}:</label>
                            <input type="text" class="form-control required number" id="discount" name="vform[discount]" value="{$ObjectData.discount}"/>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="agencies">{#AGENCIES#}:</label>
                    <select name="vform[agencies][]" id="agencies" class="form-control required" multiple>
                        <option value="">{#AGENCIES#} [i]{#PHONE#}[/i]</option>
                        {foreach key=key item=items from=$agencies}
                        <option value="{$items.id}" {if in_array($items.id, $ObjectData.agencies)}selected="selected"{/if}>{$items.code} - {$items.name} [i]{$items.phone}[/i]</option>
                        {/foreach}
                    </select>
                </div>
                <div class="row">
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label for="ordering">{#ORDERING#}:</label>
                            <select id="ordering" name="vform[ordering]" class="form-control">
                                <option value="0">{#OPTION_FIRST#}</option>
                                {foreach key = key item = items from = $Ordering }
                                <option value="{$items.value}" {if $ObjectData.ordering eq $items.value}selected="selected"{/if}>{$items.text}</option>
                                {/foreach}
                                <option value="{$items.value+1}">{#OPTION_LAST#}</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label for="published">{#PUBLISHED#}: </label>
                            <select id="published" name="vform[published]" class="form-control">
                                <option value="1" {if $ObjectData.published eq 1}selected="selected"{/if}>{#OPTION_PUBLISH#}</option>
                                <option value="0" {if $ObjectData.published eq '0'}selected="selected"{/if}>{#OPTION_UNPUBLISH#}</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!--
                <div class="form-group">
                    <label for="social">{#FILE_SOCIAL#}:</label>
                    <div class="row">
                        <div class="col-sm-6">
                            <input type="file" class="form-control" id="social" name="social" value="{$ObjectData.social}" />
                        </div>
                        <div class="col-sm-6">
                            {if $ObjectData.social}
                            <div class="overview">
                                <a social="{$ObjectData.social}" class="tooltip remsocial" style="display:block;float:left;margin-top:3px;" href="javascript:;">Thumbnail</a>
                                <img id="itemsocial" src="{$smarty.const.IMG_URL}prequotation/{$ObjectData.social}" class="thumbnail"/>
                            </div>
                            <input type="hidden" id="remsocial" name="vform[remsocial]" value="0"/>
                            {/if}
                        </div>
                    </div>
                </div>
                -->
                <button type="button" id="export" class="btn btn-primary">{#EXPORT_EXCEL#}</button>
                <button type="button" id="sendto" class="btn btn-primary">{#SEND_AGENCIES#}</button>
            </fieldset>
        </div>
    </div>

    {if count($journeies) gt 0}
    {literal}
    <script type="text/javascript">
    jQuery(document).ready(function($) {
        $('form#form-admin #quotation-list fieldset').each(function(day){
            $(this).find('#service-list >div').each(function(num){
                var group = $(this);
                group.find('select.profile').load("index.php?option=prequotation&view=callajax&task=getParentServices&ajax=1", {
                    genre: group.find('select.service option:selected').val(), location: group.find('select.location option:selected').val(), setvalue: group.find('select.profile').attr('setvalue')
                }, function(){
                    $(this).trigger("chosen:updated");
                    group.find('select.detail').load("index.php?option=prequotation&view=callajax&task=getChildrenService&ajax=1", {
                        genre: group.find('select.service option:selected').val(), parent: group.find('select.profile option:selected').val(), setvalue: group.find('select.detail').attr('setvalue'), arrival: $('input#departure').val()
                    }, function(){
                        $(this).trigger("chosen:updated");
                    });
                });
            });
        });
    });
    </script>
    {/literal}
    {/if}

    <div id="quotation-list">
        {foreach key=key item=journey from=$journeies}
        <fieldset id="day-{$key}" item="{$key}" class="adminform" style="margin-top: 20px;">
            <legend class="bg-success">
                <label># {#DAY#} {$key+1}</label><button type="button" id="del-journey-{$key}" class="del-journey btn btn-danger">{#DEL_JOURNEY#}</button>
            </legend>
            <input type="hidden" id="journey-id" name="vdata[jid][]" value="{$journey.id}"/>
            <div class="row">
                <div class="col-sm-3">
                    <div class="form-group">
                        <label for="from-{$key}">{#FROM#}: <i class="text-danger note"><span class="glyphicon glyphicon-info-sign"></span> {#CHANGE_F_LOCATION_NOTE#}</i></label>
                        <select id="from-{$key}" name="vdata[f_location][]" class="form-control f_location" style="min-width: 200px;">
                            {assign var="c_name" value=""}
                            {foreach key=i item=items from=$locations}

                            {if $c_name neq $items.c_name}
                            <optgroup label=" {$items.c_name}">
                                {assign var="c_name" value=$items.c_name}
                                {/if}

                                <option value="{$items.id}" {if $items.id eq $journey.f_location}selected="selected"{/if}>{$items.code} - {$items.name}</option>

                            {if $c_name neq $items.c_name || ($i+1) eq count($locations)}
                            </optgroup>
                            {/if}

                            {/foreach}
                        </select>
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="form-group">
                        <label for="to-{$key}">{#TO#}: <i class="text-danger note"><span class="glyphicon glyphicon-info-sign"></span> {#CHANGE_T_LOCATION_NOTE#}</i></label>
                        <select id="to-{$key}" name="vdata[t_location][]" class="form-control t_location" style="min-width: 200px;">
                            {assign var="c_name" value=""}
                            {foreach key=i item=items from=$locations}

                            {if $c_name neq $items.c_name}
                            <optgroup label=" {$items.c_name}">
                                {assign var="c_name" value=$items.c_name}
                                {/if}

                                <option value="{$items.id}" {if $items.id eq $journey.t_location}selected="selected"{/if}>{$items.code} - {$items.name}</option>

                                {if $c_name neq $items.c_name || ($i+1) eq count($locations)}
                            </optgroup>
                            {/if}

                            {/foreach}
                        </select>
                    </div>
                </div>
                <div class="col-sm-4">
                    <label for="intro-{$key}">{#INTROTEXT#}</label>
                    <textarea class="form-control" id="intro-{$key}" name="vdata[introtext][]">{$journey.introtext}</textarea>
                </div>
                <div class="col-sm-2">
                    <label style="display: block;">&nbsp;</label>
                    <button type="button" id="add-service-{$key}" class="add-service btn btn-warning pull-right">{#ADD_SERVICE#}</button>
                </div>
            </div>

            <div id="service-list">
                {foreach key=index item=service from=$journey.services}
                <div id="service-item-{$index}">
                    <input type="hidden" id="service-id" name="vdata[sid][{$key}][{$index}]" value="{$service.id}"/>
                    <hr style="margin: 5px 0;"/>
                    <div class="row">
                        <div class="col-sm-2">
                            <div class="form-group">
                                <label for="control-{$key}-{$index}-0">{#SERVICE#}: </label>
                                <select id="control-{$key}-{$index}-0" name="vdata[service][{$key}][{$index}]" field="service" class="form-control service" style="min-width: 100%;">
                                    <option value="">{#SERVICE#}</option>
                                    {foreach key=value item=label from=$sergenres}
                                    <option value="{$value}" {if $value eq $service.service}selected="selected"{/if}>{$label}</option>
                                    {/foreach}
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label for="control-{$key}-{$index}-1">{#LOCATION#}: </label>
                                <select id="control-{$key}-{$index}-1" name="vdata[location][{$key}][{$index}]" field="location" class="form-control location" style="min-width: 100%;">
                                    <option value="">{#LOCATION#}</option>
                                    {foreach key=i item=items from=$locations}
                                        {if $items.id eq $journey.f_location || $items.id eq $journey.t_location}
                                        <option value="{$items.id}" {if $items.id eq $service.location}selected="selected"{/if}>{$items.code} - {$items.name}</option>
                                        {/if}
                                    {/foreach}
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label for="control-{$key}-{$index}-2">{#PROFILE#}: </label>
                                <select id="control-{$key}-{$index}-2" setvalue="{$service.profile}" name="vdata[profile][{$key}][{$index}]" field="profile" class="form-control profile" style="min-width: 100%;">
                                    <option value="">{#PROFILE#}</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label for="control-{$key}-{$index}-3">{#DETAIL#}: </label>
                                <select id="control-{$key}-{$index}-3" setvalue="{$service.detail}" name="vdata[detail][{$key}][{$index}]" field="detail" class="form-control detail" style="min-width: 100%;">
                                    <option value="">{#DETAIL#}</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class="form-group">
                                <label for="control-{$key}-{$index}-4">{#MARKUP#}:</label>
                                <input type="text" class="form-control number markup" field="markup" id="control-{$key}-{$index}-4" name="vdata[markup][{$key}][{$index}]" value="{$service.markup}"/>
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class="form-group">
                                <label for="control-{$key}-{$index}-5">{#DISCOUNT#}:</label>
                                <input type="text" class="form-control number discount" field="discount" id="control-{$key}-{$index}-5" name="vdata[discount][{$key}][{$index}]" value="{$service.discount}"/>
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class="form-group">
                                <label for="control-{$key}-{$index}-6">{#CONVERSION#}:</label>
                                <input type="text" class="form-control number conversion" field="conversion" id="control-{$key}-{$index}-6" name="vdata[conversion][{$key}][{$index}]" value="{$service.conversion}"/>
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class="form-group">
                                <label for="del-service" style="display: block;">&nbsp;</label>
                                <button type="button" id="dup-service" class="dup-service btn btn-success" item="service-item-{$index}">{#DUP_SERVICE#}</button>
                                <button type="button" id="del-service" class="del-service btn btn-danger" item="service-item-{$index}">{#DEL_SERVICE#}</button>
                            </div>
                        </div>
                        <div class="col-sm-12">
                            {assign var=paxrange value=$journey.paxrange|json_decode:1}
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                    <tr class="bg-primary">
                                        <th class="text-center">{#PRICE#}</th>
                                        {foreach item=items from=$paxrange}
                                        <th class="text-center">{$items.label}</th>
                                        {/foreach}
                                        <th class="text-center">{#SINGLE#}</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr class="bg-info">
                                        <td class="text-center prices">
                                            <input type="text" id="control-{$key}-{$index}-7" name="vdata[price][{$key}][{$index}]" field="price" class="form-control number price" value='{$service.price|number_format:"2"}'>
                                            <input type="hidden" id="control-{$key}-{$index}-8" name="vdata[update][{$key}][{$index}]" field="update" class="update" value="0">
                                        </td>
                                        {foreach item=items from=$paxrange}
                                        <td class="text-center perpax">{if $items.value neq null}{$items.value|number_format:"2"}{/if}</td>
                                        {/foreach}
                                        <td class="text-center single">{if $service.single neq null}{$service.single}{/if}</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {/foreach}
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <button type="button" id="add-service-{$key}" class="add-service btn btn-warning pull-right">{#ADD_SERVICE#}</button>
                </div>
            </div>
        </fieldset>
        {/foreach}
    </div>
</form>

<div id="service-sample" style="display: none;">
    <fieldset id="day-n" item="n" class="adminform" style="margin-top: 20px;">
        <legend class="bg-success"><label># {#DAY#} n</label><button type="button" id="del-journey" class="del-journey btn btn-danger">{#DEL_JOURNEY#}</button></legend>
        <div class="row">
            <div class="col-sm-3">
                <div class="form-group">
                    <label for="f_location">{#FROM#}: <i class="text-danger note"><span class="glyphicon glyphicon-info-sign"></span> {#CHANGE_F_LOCATION_NOTE#}</i></label>
                    <select id="f_location" name="vdata[f_location][]" class="form-control- f_location" style="min-width: 200px;">
                        {assign var="c_name" value=""}
                        {foreach key=i item=items from=$locations}

                        {if $c_name neq $items.c_name}
                        <optgroup label=" {$items.c_name}">
                        {assign var="c_name" value=$items.c_name}
                        {/if}

                            <option value="{$items.id}" {if $items.id eq $ObjectData.from}selected="selected"{/if}>{$items.code} - {$items.name}</option>

                        {if $c_name neq $items.c_name || ($i+1) eq count($locations)}
                        </optgroup>
                        {/if}

                        {/foreach}
                    </select>
                </div>
            </div>
            <div class="col-sm-3">
                <div class="form-group">
                    <label for="t_location">{#TO#}: <i class="text-danger note"><span class="glyphicon glyphicon-info-sign"></span> {#CHANGE_T_LOCATION_NOTE#}</i></label>
                    <select id="t_location" name="vdata[t_location][]" class="form-control- t_location" style="min-width: 200px;">
                        {assign var="c_name" value=""}
                        {foreach key=i item=items from=$locations}

                        {if $c_name neq $items.c_name}
                        <optgroup label=" {$items.c_name}">
                        {assign var="c_name" value=$items.c_name}
                        {/if}

                            <option value="{$items.id}" {if $items.id eq $ObjectData.from}selected="selected"{/if}>{$items.code} - {$items.name}</option>

                        {if $c_name neq $items.c_name || ($i+1) eq count($locations)}
                        </optgroup>
                        {/if}

                        {/foreach}
                    </select>
                </div>
            </div>
            <div class="col-sm-4">
                <label for="intro">{#INTROTEXT#}</label>
                <textarea class="form-control" id="intro" name="vdata[introtext][]"></textarea>
            </div>
            <div class="col-sm-2">
                <label style="display: block;">&nbsp;</label>
                <button type="button" id="add-service" class="add-service btn btn-warning pull-right">{#ADD_SERVICE#}</button>
            </div>
        </div>
        <div id="service-list"></div>
        <div class="row">
            <div class="col-sm-12">
                <button type="button" id="add-service" class="add-service btn btn-warning pull-right">{#ADD_SERVICE#}</button>
            </div>
        </div>
    </fieldset>
</div>
<div id="price-sample" style="display: none;">
    <div id="service-item-n">
        <hr style="margin: 5px 0;"/>
        <div class="row">
            <div class="col-sm-2">
                <div class="form-group">
                    <label for="service">{#SERVICE#}: </label>
                    <select id="service" name="vdata[service][]" field="service" class="form-control- service" style="min-width: 100%;">
                        <option value="">{#SERVICE#}</option>
                        {foreach key=value item=label from=$sergenres}
                        <option value="{$value}" {if $value eq $ObjectData.genre}selected="selected"{/if}>{$label}</option>
                        {/foreach}
                    </select>
                </div>
            </div>
            <div class="col-sm-4">
                <div class="form-group">
                    <label for="location">{#LOCATION#}: </label>
                    <select id="location" name="vdata[location][]" field="location" class="form-control- location" style="min-width: 100%;">
                        <option value="">{#LOCATION#}</option>
                        {assign var="c_name" value=""}
                        {foreach key=i item=items from=$locations}

                        {if $c_name neq $items.c_name}
                        <optgroup label=" {$items.c_name}">
                            {assign var="c_name" value=$items.c_name}
                            {/if}

                            <option value="{$items.id}" {if $items.id eq $ObjectData.from}selected="selected"{/if}>{$items.code} - {$items.name}</option>

                        {if $c_name neq $items.c_name || ($i+1) eq count($locations)}
                        </optgroup>
                        {/if}

                        {/foreach}
                    </select>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label for="profile">{#PROFILE#}: </label>
                    <select id="profile" name="vdata[profile][]" field="profile" class="form-control- profile" style="min-width: 100%;">
                        <option value="">{#PROFILE#}</option>
                    </select>
                </div>
            </div>
            <div class="col-sm-4">
                <div class="form-group">
                    <label for="detail">{#DETAIL#}: </label>
                    <select id="detail" name="vdata[detail][]" field="detail" class="form-control- detail" style="min-width: 100%;" data-placeholder="{#SERVICE#}">
                        <option value="">{#DETAIL#}</option>
                    </select>
                </div>
            </div>
            <div class="col-sm-2">
                <div class="form-group">
                    <label for="ser-markup">{#MARKUP#}:</label>
                    <input type="text" class="form-control number markup" field="markup" id="ser-markup" name="vdata[markup][]" value="{$ObjectData.markup}"/>
                </div>
            </div>
            <div class="col-sm-2">
                <div class="form-group">
                    <label for="ser-discount">{#DISCOUNT#}:</label>
                    <input type="text" class="form-control number discount" field="discount" id="ser-discount" name="vdata[discount][]" value="{$ObjectData.discount}"/>
                </div>
            </div>
            <div class="col-sm-2">
                <div class="form-group">
                    <label for="ser-conversion">{#CONVERSION#}:</label>
                    <input type="text" class="form-control number conversion" field="conversion" id="ser-conversion" name="vdata[conversion][]" value="{$ObjectData.conversion}"/>
                </div>
            </div>
            <div class="col-sm-2">
                <div class="form-group">
                    <label for="del-service" style="display: block;">&nbsp;</label>
                    <button type="button" id="dup-service" class="dup-service btn btn-success">{#DUP_SERVICE#}</button>
                    <button type="button" id="del-service" class="del-service btn btn-danger">{#DEL_SERVICE#}</button>
                </div>
            </div>
            <div class="col-sm-12">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                        <tr class="bg-primary">
                            <th class="text-center">{#PRICE#}</th>
                            {foreach item=items from=$persons}
                            <th class="text-center">{$items.name}</th>
                            {/foreach}
                            <th class="text-center">{#SINGLE#}</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr class="bg-info text-danger">
                            <td class="text-center prices">
                                <input type="text" id="ser-price" name="vdata[price][]" field="price" class="form-control number price" value='0'>
                                <input type="hidden" id="ser-update" name="vdata[update][]" field="update" class="update" value="1">
                            </td>
                            {foreach item=items from=$persons}
                            <td class="text-center perpax" minpax="{$items.minpax}" maxpax="{$items.maxpax}" divpax="{$items.divpax}">0</td>
                            {/foreach}
                            <td class="text-center single">0</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{literal}
<script type="text/javascript">
    jQuery(document).ready(function($) {
        setDelService();
        setDupService();
        setAddService();
        setEventSelect();
        setEventAddDay();

        $('button#add-quotation').click(function(){
            var html = $('#service-sample').html();
            var nums = parseInt($('input#numday').val());
            var leng = $('#quotation-list fieldset').length;
            if (leng == 0) for (var i = 0; i < nums; i++){ $('#quotation-list').append(html); }
            else if (leng < nums) for (var i = leng; i < nums; i++){ $('#quotation-list').append(html); }
            else if (leng > nums) for (var i = leng; i > nums; i--){ $('#quotation-list fieldset#day-'+(i-1)).remove(); }

            $('#quotation-list fieldset').each(function(index){ $(this).attr('id', 'day-'+index).attr('item', index); });
            $('#quotation-list legend button').each(function(index){ $(this).attr('id', 'del-journey-'+index); });
            $('#quotation-list legend label').each(function(index){ $(this).html('# {/literal}{#DAY#}{literal} '+(index+1)); });
            $('#quotation-list').find('select.form-control-').removeClass('form-control-').addClass('form-control').chosen();

            setDelService();
            setDupService();
            setAddService();
            setEventAddDay();
        });

        function setEventAddDay(){
            $('#quotation-list').find('.del-journey').unbind('click').click(function(){
                $(this).parents('fieldset').remove();
                $('#quotation-list fieldset').each(function(index){ $(this).attr('id', 'day-'+index).attr('item', index); });
                $('#quotation-list legend button').each(function(index){ $(this).attr('id', 'del-journey-'+index); });
                $('#quotation-list legend label').each(function(index){ $(this).html('# {/literal}{#DAY#}{literal} '+(index+1)); });
            });
        }

        function setAddService(){
            $('button.add-service').unbind('click').click(function(){
                var group = $(this).parents('fieldset');
                var ditem = group.attr('item');

                group.find('#service-list').append($('#price-sample').html());
                group.find('#service-list').find('select.form-control-').removeClass('form-control-').addClass('form-control').chosen();
                group.find('#service-list >div').each(function(index){
                    if ($(this).is(':last-child')){
                        var markup = $('#markup').val();
                        var convert = $('#conversion').val();
                        var discount = $('#discount').val();

                        $(this).find('select.location').empty()
                                .append('<option value="">{/literal}{#LOCATION#}{literal}</option>')
                                .append('<option value="'+group.find('select.f_location option:selected').val()+'">'+group.find('select.f_location option:selected').text()+'</option>')
                                .append('<option value="'+group.find('select.t_location option:selected').val()+'">'+group.find('select.t_location option:selected').text()+'</option>')
                                .trigger("chosen:updated");
                    }

                    $(this).attr('id', 'service-item-'+index);
                    $(this).find('label').each(function(i){ $(this).attr('for', 'control-'+ditem+'-'+index+'-'+i); });
                    $(this).find('select, input[type="text"]').each(function(i){
                        var field = $(this).attr('field');
                        $(this).attr('id', 'control-'+ditem+'-'+index+'-'+i).attr('name', 'vdata['+field+']['+ditem+']['+index+']');
                        if (typeof convert != 'undefined' && field == 'conversion') $(this).val(convert);
                        if (typeof markup != 'undefined' && field == 'markup') $(this).val(markup);
                        if (typeof discount != 'undefined' && field == 'discount') $(this).val(discount);
                    });

                    $(this).find('.del-service').attr('item', 'service-item-'+index);
                    $(this).find('.dup-service').attr('item', 'service-item-'+index);

                    setDelService();
                    setDupService();
                });
                setEventSelect();
            });
        }

        function setDelService(){
            $('button.del-service').unbind('click').on('click', function(){
                var ditem = $(this).parents('fieldset').attr('item');
                var group = $(this).parents('#service-list');
                group.find('>div#'+$(this).attr('item')).remove();
                group.find('>div').each(function(k){
                    $(this).find('.dup-service').attr('item', 'service-item-'+k);
                    $(this).find('.del-service').attr('item', 'service-item-'+k);

                    $(this).attr('id', 'service-item-'+k);
                    $(this).find('label').each(function(i){ $(this).attr('for', 'control-'+ditem+'-'+k+'-'+i); });
                    $(this).find('select, input[type="text"]').each(function(i){
                        var field = $(this).attr('field');
                        $(this).attr('id', 'control-'+ditem+'-'+k+'-'+i).attr('name', 'vdata['+field+']['+ditem+']['+k+']');
                    });
                });
            });
        }

        function setDupService(){
            $('button.dup-service').unbind('click').on('click', function(){
                var ditem = $(this).parents('fieldset').attr('item');
                var group = $(this).parents('#service-list');
                group.append(group.find('>div#'+$(this).attr('item')).clone().wrap('<div />').parent().html());
                group.find('>div').each(function(k){
                    $(this).find('.dup-service').attr('item', 'service-item-'+k);
                    $(this).find('.del-service').attr('item', 'service-item-'+k);

                    $(this).attr('id', 'service-item-'+k);
                    $(this).find('label').each(function(i){ $(this).attr('for', 'control-'+ditem+'-'+k+'-'+i); });
                    $(this).find('select, input[type="text"]').each(function(i){
                        var field = $(this).attr('field');
                        $(this).attr('id', 'control-'+ditem+'-'+k+'-'+i).attr('name', 'vdata['+field+']['+ditem+']['+k+']');
                    });

                    if ($(this).is(':last-child')){
                        $(this).find('input[type="hidden"]').remove();
                        $(this).find('.chosen-container').remove();
                        $(this).find('select.form-control').show().chosen();
                    }
                    setDupService();
                    setDelService();
                    setEventSelect();
                });
            });
        }

        function setEventSelect(){
            $('select.f_location, select.t_location').unbind('change').change(function(){
                var group = $(this).parents('.row').parent();
                group.find('select.location').empty()
                        .append('<option value="">{/literal}{#LOCATION#}{literal}</option>')
                        .append('<option value="'+group.find('select.f_location option:selected').val()+'">'+group.find('select.f_location option:selected').text()+'</option>')
                        .append('<option value="'+group.find('select.t_location option:selected').val()+'">'+group.find('select.t_location option:selected').text()+'</option>')
                        .trigger("chosen:updated");

                group.find('input.price').val(0);
                group.find('table tbody td').html(0);
                group.find('select.profile').html('<option value="">{/literal}{#PROFILE#}{literal}</option>').trigger("chosen:updated");
                group.find('select.detail').html('<option value="">{/literal}{#DETAIL#}{literal}</option>').trigger("chosen:updated");
            });

            $('select.service, select.location').unbind('change').change(function(){
                var group = $(this).parents('.row');
                group.find('input.price').val(0);
                group.find('table tbody td').html(0);
                group.find('select.detail').html('<option value="">{/literal}{#DETAIL#}{literal}</option>').trigger("chosen:updated");
                group.find('select.profile').load("index.php?option=prequotation&view=callajax&task=getParentServices&ajax=1", {
                    genre: group.find('select.service option:selected').val(), location: group.find('select.location option:selected').val()
                }, function(){
                    $(this).trigger("chosen:updated");
                });
            });

            $('select.profile').unbind('change').change(function(){
                var group = $(this).parents('.row');
                group.find('input.price').val(0);
                group.find('table tbody td').html(0);
                group.find('select.detail').load("index.php?option=prequotation&view=callajax&task=getChildrenService&ajax=1", {
                    genre: group.find('select.service option:selected').val(), parent: group.find('select.profile option:selected').val(), arrival: $('input#departure').val()
                }, function(){
                    $(this).trigger("chosen:updated");
                });
            });

            $('select.detail').unbind('change').change(function(){
                var group = $(this).parents('.row');
                group.find('input.price').val(0);
                group.find('table tbody').load("index.php?option=prequotation&view=callajax&task=getDetailService&ajax=1", {
                    genre: group.find('select.service option:selected').val(),
                    parent: group.find('select.profile option:selected').val(),
                    convert: number_format(group.find('input.conversion').val(), 2, '.', ''),
                    price: number_format(group.find('input.price').val(), 2, '.', ''),
                    day: group.parents('fieldset').attr('item'),
                    num: parseInt(group.parents('[id*="service-item-"]').attr('id').replace('service-item-', '')),
                    id: group.find('select.detail option:selected').val()
                }, function(){
                    setEventSelect();
                });
            });

            var valpre = 0;
            $('input.conversion, input.price').unbind('focus').focus(function(){
                valpre = number_format($(this).val(), 2, '.', '');
            });
            $('input.conversion, input.price').unbind('blur').blur(function(){
                if (number_format(valpre, 2) != number_format($(this).val(), 2)){
                    $(this).attr('value', $(this).val());
                    if (!$(this).hasClass('error')){
                        var group = $(this).parents('.row');
                        if (group.find('select.detail option:selected').val() > 0){
                            group.find('table tbody').load("index.php?option=prequotation&view=callajax&task=getDetailService&ajax=1", {
                                genre: group.find('select.service option:selected').val(),
                                parent: group.find('select.profile option:selected').val(),
                                convert: number_format(group.find('input.conversion').val(), 2, '.', ''),
                                price: number_format(group.find('input.price').val(), 2, '.', ''),
                                day: group.parents('fieldset').attr('item'),
                                num: parseInt(group.parents('[id*="service-item-"]').attr('id').replace('service-item-', '')),
                                id: group.find('select.detail option:selected').val()
                            }, function(){
                                setEventSelect();
                            });
                        }
                    }
                }
            });
        }
    });
</script>
{/literal}